---
title: "OCS"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
library(magrittr)
R.utils::sourceDirectory("~/git/vecf_counts/src/functions/")
source(file = "~/git/vecf_counts/src/functions/fix_column_names.R")
source(file = "~/git/vecf_counts/src/functions/is_blank.R")

cust_by_yr <- fix_column_names(data.table::fread("~/git/vecf_counts/data/original/q4/OCS/OCS Services By Year.csv", colClasses = "character"))
values <- fix_column_names(data.table::fread("~/git/vecf_counts/data/original/ExportedValues.csv"))
```


match_type - missing in metadata, 100% of records have value "D"
Skipping associated_id
program year only 2016 
service duration - days? 
note all values represent some type of service - are we distinguishing at all? 

```{r columns, echo=FALSE}
#. unique_id ----
pct_complete_unique_id <- (nrow(cust_by_yr) - cust_by_yr[is_blank(unique_id), .N]) / nrow(cust_by_yr)
#.. unique value count ----
unq_count_unique_id <- nrow(unique(cust_by_yr[, .(unique_id)]))
#.. valid values ----
wrong_id_length <- cust_by_yr[nchar(unique_id) != 7, .N]
pct_valid_values_unique_id <- (nrow(cust_by_yr) - wrong_id_length) / nrow(cust_by_yr)

#. indicator columns - clinical medication, dsmiv, medicaid ----
pct_complete_clin_med <- (nrow(cust_by_yr) - cust_by_yr[is_blank(clinical_medication), .N]) / nrow(cust_by_yr)
pct_complete_dsmiv <- (nrow(cust_by_yr) - cust_by_yr[is_blank(dsmiv), .N]) / nrow(cust_by_yr)
pct_complete_medicaid <- (nrow(cust_by_yr) - cust_by_yr[is_blank(medicaid_enrolled), .N]) / nrow(cust_by_yr)
#.. unique value count ----
unq_count_clin_med <- nrow(unique(cust_by_yr[, .(clinical_medication)]))
unq_count_dsmiv <- nrow(unique(cust_by_yr[, .(dsmiv)]))
unq_count_medicaid <- nrow(unique(cust_by_yr[, .(medicaid_enrolled)]))
#.. valid values ----
pct_valid_values_clin_med <- (nrow(cust_by_yr) - cust_by_yr[is_blank(clinical_medication), .N]) / nrow(cust_by_yr)
pct_valid_values_dsmiv <- (nrow(cust_by_yr) - cust_by_yr[is_blank(dsmiv), .N]) / nrow(cust_by_yr)
pct_valid_values_medicaid <- (nrow(cust_by_yr) - cust_by_yr[is_blank(medicaid_enrolled), .N]) / nrow(cust_by_yr)

#. date columns - program year, servoce begin date, service end date ----
pct_complete_prog_yr <- (nrow(cust_by_yr) - cust_by_yr[is_blank(program_year), .N]) / nrow(cust_by_yr)
pct_complete_serv_begin <- (nrow(cust_by_yr) - cust_by_yr[is_blank(service_begin_date), .N]) / nrow(cust_by_yr)
pct_complete_serv_end <- (nrow(cust_by_yr) - cust_by_yr[is_blank(service_end_date), .N]) / nrow(cust_by_yr)
#.. unique value count ----
unq_count_prog_yr <- nrow(unique(cust_by_yr[, .(program_year)]))
unq_count_serv_begin <- nrow(unique(cust_by_yr[, .(service_begin_date)]))
unq_count_serv_end <- nrow(unique(cust_by_yr[, .(service_end_date)]))
#.. valid values ----
pct_valid_values_prog_yr <- (nrow(cust_by_yr) - cust_by_yr[!as.integer(program_year) %in% 2013:2016, .N]) / nrow(cust_by_yr)
pct_valid_values_serv_beg <- (nrow(cust_by_yr) - 
                               cust_by_yr[!stringr::str_sub(cust_by_yr$service_begin_date, start = 7L, end = 10L) %in% 2013:2016, .N]) / 
                                nrow(cust_by_yr)
pct_valid_values_serv_end <- (nrow(cust_by_yr) - 
                               cust_by_yr[!stringr::str_sub(cust_by_yr$service_end_date, start = 7L, end = 10L) %in% 2013:2016, .N]) / 
                              nrow(cust_by_yr)

#. service columns - service duration, service placement ----
pct_complete_serv_dur <- (nrow(cust_by_yr) - cust_by_yr[is_blank(service_duration), .N]) / nrow(cust_by_yr)
pct_complete_serv_place <- (nrow(cust_by_yr) - cust_by_yr[is_blank(service_placement_type), .N]) / nrow(cust_by_yr)
#.. unique value count ----
unq_count_serv_dur <- nrow(unique(cust_by_yr[, .(service_duration)]))
unq_count_serv_place <- nrow(unique(cust_by_yr[, .(service_placement_type)]))
#.. valid values ----
pct_valid_values_serv_dur <- (nrow(cust_by_yr) - cust_by_yr[is_blank(service_duration), .N]) / nrow(cust_by_yr)
pct_valid_values_serv_place <- (nrow(cust_by_yr) - cust_by_yr[is_blank(service_placement_type), .N]) / nrow(cust_by_yr)


```


### Column Profiles

#####Unique IDs

```{r UniqueID, echo = FALSE}
IDeval <- tibble::tibble("Column" = "ID", "Measure" = c("% Complete", "# Unique", "% Valid "), 
                         "Value" = c(pct_complete_unique_id, 
                                     unq_count_unique_id, pct_valid_values_unique_id))

knitr::kable(reshape2::recast(IDeval, Column~Measure))
```

#####Indicator Columns

```{r Age, echo = FALSE}

Indeval <- 
  rbind(
    tibble::tibble("Column" = "Medication", "Measure"=c("% Complete", "# Unique", "% Valid "),
                   "Value" = c(pct_complete_clin_med, 
                               unq_count_clin_med, pct_valid_values_clin_med)),
    tibble::tibble("Column" = "DSMIV", "Measure"=c("% Complete", "# Unique", "% Valid "),
               "Value" = c(pct_complete_dsmiv, 
                           unq_count_dsmiv, pct_valid_values_dsmiv)),
    tibble::tibble("Column" = "Medicaid", "Measure"=c("% Complete", "# Unique", "% Valid "),
                   "Value" = c(pct_complete_medicaid, 
                               unq_count_medicaid, pct_valid_values_medicaid))
    ) #rbind  

knitr::kable(reshape2::recast(Indeval, Column~Measure))
```

#####Date Columns

```{r school, echo = FALSE}
DATEeval <- 
  rbind(
    tibble::tibble("Column" = "Program Year", "Measure"=c("% Complete", "# Unique", "% Valid "),
                   "Value" = c(pct_complete_prog_yr, unq_count_prog_yr, 
                               pct_valid_values_prog_yr)),
    tibble::tibble("Column" = "Service Begin", "Measure"=c("% Complete", "# Unique", "% Valid "),
                   "Value" = c(pct_complete_serv_begin, unq_count_serv_begin, 
                               pct_valid_values_serv_beg)),
    tibble::tibble("Column" = "Service End", "Measure"=c("% Complete", "# Unique", "% Valid "),
                   "Value" = c(pct_complete_serv_end, unq_count_serv_end, 
                               pct_valid_values_serv_end))
  ) #rbind

knitr::kable(reshape2::recast(DATEeval, Column~Measure))
```

#####Service Indicators

For reference: the services values & meanings. Technically the Foster Definition comes from a different view - but the values should be the same. 

```{r servdict, echo=TRUE}
serv_dict <- values[view_name == "OCS Services By Year"][stringr::str_detect(column_name, "Service Placement")]
knitr::kable(serv_dict[,2:5])
```

```{r serviceind, echo=FALSE}

SERVICEINDeval <-
  rbind(
    tibble::tibble("Column" = "Duration", "Measure"=c("% Complete", "# Unique", "% Valid "),
                   "Value" = c(pct_complete_serv_dur, unq_count_serv_dur, 
                               pct_valid_values_serv_dur)),
    tibble::tibble("Column" = "Placement", "Measure"=c("% Complete", "# Unique", "% Valid "),
                   "Value" = c(pct_complete_serv_place, unq_count_serv_place, 
                               pct_valid_values_serv_place))
  ) #rbind
knitr::kable(reshape2::recast(SERVICEINDeval, Column~Measure))
```

### Summary Table

```{R}
SummaryEval <- rbind(IDeval, Indeval, DATEeval, SERVICEINDeval)
knitr::kable(reshape2::recast(SummaryEval, Column~Measure))
```









